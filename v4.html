<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
  <title>Teachable Micro:Bit ‚Äî Audio Model</title>

  <!-- Audio model dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

  <!-- Bluetooth bridge (exactly as in v4) -->
  <script src="microbit_uart_ble.js"></script>

  <style>
    html,body{margin:0;height:100%;display:grid;place-items:center;background:#e0551b;color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:grid;gap:10px;place-items:center}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;background:#fff;color:#e0551b;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    #status{font-weight:800}
  </style>
</head>

<body>
  <div class="wrap">
    <div>
      <button id="connect">üîó Connect micro:bit</button>
      <button id="start">üéôÔ∏è Start Listening</button>
    </div>
    <div id="status">Idle</div>
  </div>

  <script>
    /* ===== Teachable Machine Audio Model ===== */
    const url = new URL(location.href);
    const id  = url.searchParams.get("model") || "fww4C8ATZ";
    const MODEL_BASE = /^https?:\/\//.test(id)
      ? (id.endsWith("/") ? id : id + "/")
      : `https://teachablemachine.withgoogle.com/models/${id}/`;

    const PROB_THRESHOLD = 0.75;
    const OVERLAP = 0.50;
    const SEND_SUFFIX = "\n";
    const MAP_TO_UART = {};

    const $ = s => document.querySelector(s);
    const setStatus = t => $("#status").textContent = t;

    let recognizer, labels, lastLabel = "";

    async function createModel() {
      const rec = speechCommands.create(
        "BROWSER_FFT",
        undefined,
        MODEL_BASE + "model.json",
        MODEL_BASE + "metadata.json"
      );
      await rec.ensureModelLoaded();
      return rec;
    }

    function sendLine(s){
      if (typeof sendUART === "function") {
        sendUART(String(s) + SEND_SUFFIX);
      } else {
        console.warn("sendUART() ontbreekt ‚Äì controleer microbit_uart_ble.js");
      }
    }

    async function startListening(){
      try {
        setStatus("Model laden‚Ä¶");
        recognizer = await createModel();
        labels = recognizer.wordLabels();

        setStatus("Luisteren‚Ä¶ (microfoon toestaan)");
        recognizer.listen(result => {
          const scores = result.scores;
          let top = 0;
          for (let i=1; i<scores.length; i++) if (scores[i] > scores[top]) top = i;

          const label = labels[top];
          const prob  = scores[top];
          setStatus(`${label} (${(prob*100).toFixed(0)}%)`);

          if (prob >= PROB_THRESHOLD && label !== lastLabel) {
            const cmd = (label in MAP_TO_UART) ? MAP_TO_UART[label] : label;
            sendLine(cmd);
            lastLabel = label;
          }
        }, {
          includeSpectrogram: true,
          probabilityThreshold: PROB_THRESHOLD,
          invokeCallbackOnNoiseAndUnknown: true,
          overlapFactor: OVERLAP
        });
      } catch (err) {
        console.error(err);
        alert("Kon audio-model niet starten: " + (err.message || "zie console"));
        setStatus("Error");
      }
    }
  </script>
</body>
</html>
